From 31590740c11bc5926a3b925b42591a988f9cd7ee Mon Sep 17 00:00:00 2001
From: Ilya Zlobintsev <ilya.zl@protonmail.com>
Date: Sun, 8 Aug 2021 20:09:55 +0300
Subject: [PATCH 1/8] FeelsDankMan

---
 src/common/Version.cpp     | 12 ++++++++++++
 src/common/Version.hpp     |  1 +
 src/singletons/Updates.cpp |  6 ++++--
 src/util/StreamLink.cpp    | 11 ++++++++++-
 4 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/src/common/Version.cpp b/src/common/Version.cpp
index aa8639dcef..fd5b16fc3b 100644
--- a/src/common/Version.cpp
+++ b/src/common/Version.cpp
@@ -71,4 +71,16 @@ const bool &Version::isSupportedOS() const
     return this->isSupportedOS_;
 }
 
+const bool &Version::isFlatpak() const
+{
+    if (QFileInfo::exists("/.flatpak-info"))
+    {
+        return true;
+    }
+    else
+    {
+        return false;
+    }
+}
+
 }  // namespace chatterino
diff --git a/src/common/Version.hpp b/src/common/Version.hpp
index 1a858c0ea1..c23aee2b12 100644
--- a/src/common/Version.hpp
+++ b/src/common/Version.hpp
@@ -29,6 +29,7 @@ class Version
     const QString &dateOfBuild() const;
     const QString &fullVersion() const;
     const bool &isSupportedOS() const;
+    const bool &isFlatpak() const;
 
 private:
     Version();
diff --git a/src/singletons/Updates.cpp b/src/singletons/Updates.cpp
index 5751b59cc5..cf32b30ff8 100644
--- a/src/singletons/Updates.cpp
+++ b/src/singletons/Updates.cpp
@@ -232,7 +232,9 @@ void Updates::installUpdates()
 
 void Updates::checkForUpdates()
 {
-    if (!Version::instance().isSupportedOS())
+    auto version = Version::instance();
+
+    if (!version.isSupportedOS())
     {
         qCDebug(chatterinoUpdate)
             << "Update checking disabled because OS doesn't appear to be one "
@@ -241,7 +243,7 @@ void Updates::checkForUpdates()
     }
 
     // Disable updates on Flatpak
-    if (QFileInfo::exists("/.flatpak-info"))
+    if (version.isFlatpak())
     {
         return;
     }
diff --git a/src/util/StreamLink.cpp b/src/util/StreamLink.cpp
index 2ac42cfa64..f98f77921b 100644
--- a/src/util/StreamLink.cpp
+++ b/src/util/StreamLink.cpp
@@ -10,6 +10,7 @@
 #include <QFileInfo>
 #include <QProcess>
 #include "common/QLogging.hpp"
+#include "common/Version.hpp"
 
 #include <functional>
 
@@ -83,7 +84,15 @@ namespace {
     QProcess *createStreamlinkProcess()
     {
         auto p = new QProcess;
-        p->setProgram(getStreamlinkProgram());
+
+        if (Version::instance().isFlatpak())
+        {
+            p->setProgram("flatpak-spawn --host " + getStreamlinkProgram());
+        }
+        else
+        {
+            p->setProgram(getStreamlinkProgram());
+        }
 
         QObject::connect(p, &QProcess::errorOccurred, [=](auto err) {
             if (err == QProcess::FailedToStart)

From ff2ec9b5d6ae4ba9a5afb8f50f858671653e5e19 Mon Sep 17 00:00:00 2001
From: Ilya Zlobintsev <ilya.zl@protonmail.com>
Date: Sun, 8 Aug 2021 20:16:02 +0300
Subject: [PATCH 2/8] Fix crash

---
 src/common/Version.cpp | 11 ++---------
 src/common/Version.hpp |  2 +-
 2 files changed, 3 insertions(+), 10 deletions(-)

diff --git a/src/common/Version.cpp b/src/common/Version.cpp
index fd5b16fc3b..9b140fc002 100644
--- a/src/common/Version.cpp
+++ b/src/common/Version.cpp
@@ -71,16 +71,9 @@ const bool &Version::isSupportedOS() const
     return this->isSupportedOS_;
 }
 
-const bool &Version::isFlatpak() const
+const bool Version::isFlatpak() const
 {
-    if (QFileInfo::exists("/.flatpak-info"))
-    {
-        return true;
-    }
-    else
-    {
-        return false;
-    }
+    return QFileInfo::exists("/.flatpak-info");
 }
 
 }  // namespace chatterino
diff --git a/src/common/Version.hpp b/src/common/Version.hpp
index c23aee2b12..9511830014 100644
--- a/src/common/Version.hpp
+++ b/src/common/Version.hpp
@@ -29,7 +29,7 @@ class Version
     const QString &dateOfBuild() const;
     const QString &fullVersion() const;
     const bool &isSupportedOS() const;
-    const bool &isFlatpak() const;
+    const bool isFlatpak() const;
 
 private:
     Version();

From af5e765de2d89d9500c4a70e85f36f4b6e895335 Mon Sep 17 00:00:00 2001
From: Ilya Zlobintsev <ilya.zl@protonmail.com>
Date: Sun, 8 Aug 2021 22:19:06 +0300
Subject: [PATCH 3/8] Hopefully this works

---
 src/util/StreamLink.cpp | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/util/StreamLink.cpp b/src/util/StreamLink.cpp
index f98f77921b..5a1be5b94c 100644
--- a/src/util/StreamLink.cpp
+++ b/src/util/StreamLink.cpp
@@ -87,7 +87,9 @@ namespace {
 
         if (Version::instance().isFlatpak())
         {
-            p->setProgram("flatpak-spawn --host " + getStreamlinkProgram());
+            p->setProgram("flatpak-spawn");
+
+            p->setArguments({"--host", getStreamlinkProgram()});
         }
         else
         {
@@ -174,7 +176,8 @@ void getStreamQualities(const QString &channelURL,
             }
         });
 
-    p->setArguments({channelURL, "--default-stream=KKona"});
+    p->setArguments(p->arguments() +
+                    QStringList({channelURL, "--default-stream=KKona"}));
 
     p->start();
 }

From 4021d87f8ca3b3c461306b8a95b07b0ac4a1417a Mon Sep 17 00:00:00 2001
From: Ilya Zlobintsev <ilya.zl@protonmail.com>
Date: Sun, 8 Aug 2021 22:35:01 +0300
Subject: [PATCH 4/8] Add more debug info

---
 src/util/StreamLink.cpp | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/util/StreamLink.cpp b/src/util/StreamLink.cpp
index 5a1be5b94c..f37ff14513 100644
--- a/src/util/StreamLink.cpp
+++ b/src/util/StreamLink.cpp
@@ -108,6 +108,8 @@ namespace {
 
             p->deleteLater();
         });
+        
+        qCWarning(chatterinoStreamlink) << "command:" << p->program() << p->arguments().join(" ");
 
         QObject::connect(
             p,

From ac00a08e64c052c6c28a9cea2a282f742135817e Mon Sep 17 00:00:00 2001
From: Ilya Zlobintsev <ilya.zl@protonmail.com>
Date: Tue, 17 Aug 2021 15:02:19 +0300
Subject: [PATCH 5/8] Start the streamlink process with flatpak-spawn

---
 src/util/StreamLink.cpp | 23 +++++++++++++++++++----
 1 file changed, 19 insertions(+), 4 deletions(-)

diff --git a/src/util/StreamLink.cpp b/src/util/StreamLink.cpp
index f37ff14513..68bdcfb102 100644
--- a/src/util/StreamLink.cpp
+++ b/src/util/StreamLink.cpp
@@ -108,8 +108,9 @@ namespace {
 
             p->deleteLater();
         });
-        
-        qCWarning(chatterinoStreamlink) << "command:" << p->program() << p->arguments().join(" ");
+
+        qCWarning(chatterinoStreamlink)
+            << "command:" << p->program() << p->arguments().join(" ");
 
         QObject::connect(
             p,
@@ -187,7 +188,21 @@ void getStreamQualities(const QString &channelURL,
 void openStreamlink(const QString &channelURL, const QString &quality,
                     QStringList extraArguments)
 {
-    QStringList arguments = extraArguments << channelURL << quality;
+    QStringList arguments;
+    
+    QString program;
+
+    if (Version::instance().isFlatpak())
+    {
+        program = "flatpak-spawn";
+        
+        arguments << "--host" << getStreamlinkProgram();
+    }
+    else {
+        program = getStreamlinkProgram();
+    }
+
+    arguments << extraArguments << channelURL << quality;
 
     // Remove empty arguments before appending additional streamlink options
     // as the options might purposely contain empty arguments
@@ -196,7 +211,7 @@ void openStreamlink(const QString &channelURL, const QString &quality,
     QString additionalOptions = getSettings()->streamlinkOpts.getValue();
     arguments << splitCommand(additionalOptions);
 
-    bool res = QProcess::startDetached(getStreamlinkProgram(), arguments);
+    bool res = QProcess::startDetached(program, arguments);
 
     if (!res)
     {

From 679a7d8cd2dc99573a027e9914667e4ba48bc3c8 Mon Sep 17 00:00:00 2001
From: Ilya Zlobintsev <ilya.zl@protonmail.com>
Date: Tue, 17 Aug 2021 15:19:42 +0300
Subject: [PATCH 6/8] Update changelog

From 86871e975093e9dfb469c3614c1a052b0b46ecc4 Mon Sep 17 00:00:00 2001
From: Ilya Zlobintsev <ilya.zl@protonmail.com>
Date: Tue, 17 Aug 2021 15:21:26 +0300
Subject: [PATCH 7/8] Fix formatting

---
 src/util/StreamLink.cpp | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/util/StreamLink.cpp b/src/util/StreamLink.cpp
index 68bdcfb102..4168bdf671 100644
--- a/src/util/StreamLink.cpp
+++ b/src/util/StreamLink.cpp
@@ -189,16 +189,17 @@ void openStreamlink(const QString &channelURL, const QString &quality,
                     QStringList extraArguments)
 {
     QStringList arguments;
-    
+
     QString program;
 
     if (Version::instance().isFlatpak())
     {
         program = "flatpak-spawn";
-        
+
         arguments << "--host" << getStreamlinkProgram();
     }
-    else {
+    else
+    {
         program = getStreamlinkProgram();
     }
